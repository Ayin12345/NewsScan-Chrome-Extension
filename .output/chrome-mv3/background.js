var background=function(){"use strict";var b,T;async function E(r,l){var s;const e=await(await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"user",content:r}]})})).json();if(e.choices&&e.choices[0]&&e.choices[0].message.content)return e.choices[0].message.content;throw new Error(((s=e.error)==null?void 0:s.message)||"No response from OpenAI")}async function P(r,l){var s;const t=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${l}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:r}]}],generationConfig:{temperature:.7,maxOutputTokens:1e3}})});if(!t.ok){const o=await t.text();throw new Error(`Gemini API error: ${t.status} ${t.statusText} - ${o}`)}const e=await t.json();if(e.candidates&&e.candidates[0]&&e.candidates[0].content&&e.candidates[0].content.parts&&e.candidates[0].content.parts[0])return e.candidates[0].content.parts[0].text;throw new Error(((s=e.error)==null?void 0:s.message)||"No response from Gemini")}async function _(r,l){var t;console.log("Llama API Key:","Present"),console.log("API Key length:",l.length);try{const e=await fetch("https://api-inference.huggingface.co/models/meta-llama/Llama-3.3-70B-Instruct",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Llama Response Status:",e.status,e.statusText),!e.ok){const o=await e.text();throw console.error("Llama API Full Error:",{status:e.status,statusText:e.statusText,errorText:o,headers:Object.fromEntries(e.headers.entries())}),new Error(`Llama API error: ${e.status} ${e.statusText} - ${o}`)}const s=await e.json();if(console.log("Llama API Response Data:",s),Array.isArray(s)&&((t=s[0])!=null&&t.generated_text))return s[0].generated_text;throw console.error("Llama API Invalid Response Format:",s),new Error(s.error||"No valid response from Llama")}catch(e){throw console.error("Llama API Call Failed:",e),e}}async function S(r,l){console.log("Cohere API Key:","Present"),console.log("Cohere API Key length:",l.length);try{const t=await fetch("https://api.cohere.ai/v1/generate",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({model:"command",prompt:r,max_tokens:1250})});if(console.log("Cohere Response Status:",t.status,t.statusText),!t.ok){const s=await t.text();throw console.error("Cohere API Full Error:",{status:t.status,statusText:t.statusText,errorText:s,headers:Object.fromEntries(t.headers.entries())}),new Error(`Cohere API error: ${t.status} ${t.statusText} - ${s}`)}const e=await t.json();if(console.log("Cohere API Response Data:",e),e.generations&&e.generations[0]&&e.generations[0].text)return e.generations[0].text;throw new Error(e.message||"No response from Cohere")}catch(t){throw console.error("Cohere API Call Failed:",t),t}}async function v(r,l){var t;try{const e=await fetch("https://api-inference.huggingface.co/models/mistralai/Mistral-7B-Instruct-v0.3",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Mistral Response Status:",e.status,e.statusText),!e.ok){const o=await e.text();throw console.error("Mistral API Full Error:",{status:e.status,statusText:e.statusText,errorText:o,headers:Object.fromEntries(e.headers.entries())}),new Error(`Mistral API error: ${e.status} ${e.statusText} - ${o}`)}const s=await e.json();if(console.log("Mistral API Response Data:",s),Array.isArray(s)&&((t=s[0])!=null&&t.generated_text))return s[0].generated_text;throw console.error("Mistral API Invalid Response Format:",s),new Error(s.error||"No valid response from Mistral 7B")}catch(e){throw console.error("Mistral API Call Failed:",e),e}}async function $(r,l){try{const t=await fetch("https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1",{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify({inputs:r,parameters:{max_new_tokens:500,temperature:.7,return_full_text:!1}})});if(console.log("Mixtral Response Status:",t.status,t.statusText),!t.ok){const s=await t.text();throw console.error("Mixtral API Full Error:",{status:t.status,statusText:t.statusText,errorText:s,headers:Object.fromEntries(t.headers.entries())}),new Error(`Mixtral API error: ${t.status} ${t.statusText} - ${s}`)}const e=await t.json();if(console.log("Mixtral API Response Data:",e),Array.isArray(e)&&e[0]&&e[0].generated_text)return e[0].generated_text;throw console.error("Mixtral API Invalid Response Format:",e),new Error(e.error||"No response from Mixtral 8x7B")}catch(t){throw console.error("Mixtral API Call Failed:",t),t}}function k(r){return r==null||typeof r=="function"?{main:r}:r}function C(r){try{return JSON.parse(r)}catch{try{let t=r.trim();const e=t.indexOf("{"),s=t.lastIndexOf("}")+1;e>=0&&s>e&&(t=t.slice(e,s)),t=t.replace(/\\n/g," ").replace(/\s+/g," ").replace(/"\s*,\s*}/g,'"}').replace(/,(\s*})/g,"$1").replace(/\.,/g,".").replace(/\."/g,'"').replace(/"\s*\.\s*$/g,'"').replace(/\[\s*,/g,"[").replace(/,\s*\]/g,"]");const o=JSON.parse(t);return o.credibility_summary&&(o.credibility_summary=o.credibility_summary.trim().replace(/\s+/g," ").replace(/\.,/g,".").replace(/\.+$/,".")),o.reasoning&&(o.reasoning=o.reasoning.trim().replace(/\s+/g," ").replace(/\.,/g,".").replace(/\.+$/,".")),Array.isArray(o.evidence_sentences)&&(o.evidence_sentences=o.evidence_sentences.map(a=>{var u,p;return{quote:((u=a.quote)==null?void 0:u.trim().replace(/\s+/g," ").replace(/\.+$/,""))||"",impact:((p=a.impact)==null?void 0:p.trim().replace(/\s+/g," ").replace(/\.+$/,""))||""}}).filter(a=>a.quote&&a.impact)),Array.isArray(o.supporting_links)&&(o.supporting_links=o.supporting_links.map(a=>a.trim()).filter(Boolean)),typeof o.credibility_score=="string"&&(o.credibility_score=parseInt(o.credibility_score,10)),o.credibility_score=Math.max(1,Math.min(100,o.credibility_score||0)),o}catch(t){throw console.error("Failed to parse cleaned JSON:",t),new Error("Invalid JSON format")}}}async function B(r,l=5){var t,e;try{console.log("=== WEB SEARCH DEBUG START ==="),console.log("Original query received:",r),console.log("Max results requested:",l),console.log("Google API Key present:",!0),console.log("Google Search Engine ID present:",!0);let s="";try{const n=r.match(/https?:\/\/([^\/]+)/);n&&(s=n[1].replace("www.",""))}catch{console.log("Could not extract domain from query")}const o=r.replace(/https?:\/\/[^\s]+/g,"").trim();let a="";try{const n=r.match(/https?:\/\/([^\/]+)/);n&&(a=n[1].replace("www.",""))}catch{console.log("Could not extract current domain from query")}const u=a?`${o} -site:${a}`:o;console.log("Enhanced search query:",u),console.log("Encoded query:",encodeURIComponent(u));const p=`https://www.googleapis.com/customsearch/v1?key=AIzaSyAIQCMO6dv-Ywnqfv2ctmV-UlBD3z1xHzI&cx=c424f03b2cfd34523&q=${encodeURIComponent(u)}&num=${l}&fields=items(title,snippet,link)`;console.log("Full search URL (without API key):",p.replace("AIzaSyAIQCMO6dv-Ywnqfv2ctmV-UlBD3z1xHzI","API_KEY_HIDDEN"));const f=await fetch(p);if(console.log("Search response status:",f.status,f.statusText),console.log("Search response headers:",Object.fromEntries(f.headers.entries())),!f.ok){const n=await f.text();throw console.error("Search API error response:",n),new Error(`Search API error: ${f.status} - ${n}`)}const g=await f.json();console.log("Raw search API response:",g),console.log("Number of results returned:",((t=g.items)==null?void 0:t.length)||0),g.items&&g.items.length>0?(console.log("Detailed search results:"),g.items.forEach((n,i)=>{var c;console.log(`Result ${i+1}:`),console.log(`  Title: ${n.title}`),console.log(`  URL: ${n.link}`),console.log(`  Snippet: ${(c=n.snippet)==null?void 0:c.substring(0,100)}...`)})):console.log("No search results found");const w=((e=g.items)==null?void 0:e.filter(n=>{const i=n.link.toLowerCase(),c=n.title.toLowerCase();if(a&&i.includes(a))return console.log(`Filtering out result from same domain: ${n.link}`),!1;const d=o.toLowerCase().split(" ").filter(I=>I.length>3);return d.filter(I=>c.includes(I)).length>d.length*.7?(console.log(`Filtering out too similar title: ${n.title}`),!1):!0}).map(n=>({url:n.link,title:n.title,snippet:n.snippet})))||[];return console.log("Processed results being returned:",w),console.log("=== WEB SEARCH DEBUG END ==="),w}catch(s){return console.error("Web search failed:",s),[]}}const h=new Map,m=()=>({pageInfo:null,analysis:[],failedProviders:[],showButton:!0,isAnalyzing:!1,hasAttemptedAnalysis:!1}),O=k({main(){chrome.runtime.onInstalled.addListener(()=>{console.log("Extension installed")}),chrome.action.onClicked.addListener(()=>{chrome.sidePanel.open({windowId:chrome.windows.WINDOW_ID_CURRENT})}),chrome.tabs.onRemoved.addListener(r=>{h.delete(r)}),chrome.tabs.onActivated.addListener(async r=>{try{console.log("Tab switched to:",r.tabId);const l=h.get(r.tabId);l&&l.analysis&&(console.log("Tab switch - Analysis state:",l.analysis),console.log("Analysis length:",l.analysis.length),l.analysis.forEach((t,e)=>{console.log(`Tab switch - Analysis ${e}:`,t.provider,t.result.credibility_summary)})),chrome.runtime.sendMessage({type:"TAB_SWITCHED",tabId:r.tabId,state:l||m()}).catch(t=>{console.log("Sidebar not open or not ready:",t)})}catch(l){console.log("Error handling tab switch:",l)}}),chrome.runtime.onMessage.addListener((r,l,t)=>{var s;const e=r.tabId||((s=l.tab)==null?void 0:s.id);if(!e)return console.error("No tab ID found in message or sender"),t({success:!1,error:"No tab ID found"}),!0;if(r.type==="GET_PAGE_INFO")return(async()=>{var o;try{const a=await chrome.tabs.sendMessage(e,{type:"GET_PAGE_CONTENT"});if(a&&a.error){t({success:!1,error:a.error});return}let u=h.get(e)||m();const p=((o=u.pageInfo)==null?void 0:o.url)===a.data.url;u={...u,pageInfo:a.data,showButton:!0,analysis:p?u.analysis:[],failedProviders:p?u.failedProviders:[],hasAttemptedAnalysis:!1},h.set(e,u),t({success:!0,data:a.data})}catch(a){console.error("Error getting page info:",a),t({success:!1,error:"Failed to fetch page info"})}})(),!0;if(r.type==="ANALYZE_ARTICLE")return(async()=>{try{const o=r.tabId;if(!o){t({success:!1,error:"No tab ID provided"});return}const a=r.providers||[];let u=h.get(o)||m();u.isAnalyzing=!0,h.set(o,u),console.log("Providers array received:",a),console.log("Providers array length:",a.length),console.log("API Keys Debug:"),console.log("Cohere key length:",40),console.log("Cohere key starts with:","d4rtWmY3HK9su8mrSbxlsrWEJod7TZyGeNH3ZvdG".substring(0,5)||"none"),console.log("Gemini key length:",39),console.log("HuggingFace key length:",37),console.log("HuggingFace key starts with:","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".substring(0,5)||"none");const p=a.map(async i=>{console.log(`Trying provider: ${i}`);try{let c;switch(i){case"OpenAI":c=await E(r.content,"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");break;case"Gemini":c=await P(r.content,"AIzaSyA82I5_GdxU23af9sklb3mLb8T-tuPP1BE");break;case"Cohere":c=await S(r.content,"d4rtWmY3HK9su8mrSbxlsrWEJod7TZyGeNH3ZvdG");break;case"Mistral7B":c=await v(r.content,"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");break;case"Mixtral8x7B":c=await $(r.content,"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");break;case"Llama":c=await _(r.content,"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");break;default:throw new Error(`Unknown provider: ${i}`)}return chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:i,status:"complete"}),console.log(`Provider ${i} completed successfully`),c}catch(c){throw console.error(`Error in provider ${i}:`,c),chrome.runtime.sendMessage({type:"PROVIDER_UPDATE",provider:i,status:"failed"}),console.log(`Provider ${i} failed`),c}}),f=await Promise.allSettled(p),g=f.map((i,c)=>{if(i.status==="fulfilled")try{let d;if(typeof i.value=="string")try{d=C(i.value)}catch(x){return console.error("Failed to parse result:",x),null}else d=i.value;return d?typeof d.credibility_score!="number"||typeof d.credibility_summary!="string"||typeof d.reasoning!="string"||!Array.isArray(d.evidence_sentences)||!Array.isArray(d.supporting_links)?(console.error("Invalid result structure:",d),null):{provider:a[c],result:d}:(console.error("No parsed result available"),null)}catch(d){return console.error(`Error processing result from provider ${a[c]}:`,d),null}return null}).filter(i=>i!==null),w=f.map((i,c)=>(console.log(`Provider ${a[c]} status:`,i.status),i.status==="rejected"?(console.error(`Provider ${a[c]} failed:`,i.reason),a[c]):(i.status==="fulfilled"&&console.log(`Provider ${a[c]} succeeded`),null))).filter(i=>i!==null);let n=h.get(o);n||(console.warn("No existing tab state found during analysis"),n=m()),n.analysis=g,n.failedProviders=w,n.showButton=!1,n.isAnalyzing=!1,n.hasAttemptedAnalysis=!0,console.log("Saving analysis state:",g),console.log("Analysis length:",g.length),g.forEach((i,c)=>{console.log(`Saving - Analysis ${c}:`,i.provider,i.result.credibility_summary)}),h.set(o,n),t({success:!0,data:f,providers:a})}catch(o){console.error("Error in analyze article:",o),t({success:!1,error:"Failed to analyze article"})}})(),!0;if(r.type==="GET_TAB_STATE"){const o=h.get(e)||m();return t({success:!0,data:o}),!0}return r.type==="RESET_TAB_STATE"?(h.delete(e),h.set(e,{pageInfo:null,analysis:[],failedProviders:[],showButton:!0,isAnalyzing:!1,hasAttemptedAnalysis:!1}),chrome.tabs.sendMessage(e,{type:"TAB_SWITCHED",state:h.get(e)}).catch(()=>{}),t({success:!0}),!0):r.type==="SAVE_TAB_STATE"?((async()=>{try{const[o]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(o!=null&&o.id)){t({success:!1,error:"No active tab found"});return}h.set(o.id,{pageInfo:r.data.pageInfo,analysis:r.data.analysis,failedProviders:r.data.failedProviders,showButton:r.data.showButton,isAnalyzing:r.data.isAnalyzing||!1,hasAttemptedAnalysis:r.data.hasAttemptedAnalysis||!1}),t({success:!0})}catch{t({success:!1,error:"Failed to save tab state"})}})(),!0):r.type==="WEB_SEARCH"?((async()=>{try{const o=await B(r.query,r.max_results);t({success:!0,data:{results:o}})}catch(o){console.error("Web search error:",o),t({success:!1,error:"Failed to perform web search"})}})(),!0):(r.type==="TAB_SWITCHED",!0)}),chrome.tabs.onUpdated.addListener((r,l,t)=>{l.status==="complete"&&h.set(r,{pageInfo:null,analysis:[],failedProviders:[],showButton:!0,isAnalyzing:!1,hasAttemptedAnalysis:!1})})}});function M(){}(T=(b=globalThis.browser)==null?void 0:b.runtime)!=null&&T.id?globalThis.browser:globalThis.chrome;function y(r,...l){}const N={debug:(...r)=>y(console.debug,...r),log:(...r)=>y(console.log,...r),warn:(...r)=>y(console.warn,...r),error:(...r)=>y(console.error,...r)};let A;try{A=O.main(),A instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(r){throw N.error("The background crashed on startup!"),r}return A}();
background;
